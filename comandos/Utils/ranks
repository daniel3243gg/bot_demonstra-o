from PDO import PDO

class Rank:
    def __init__(self, id: str):
        self.user_id = id
        self.rank_id_registro = None
        self.ranks = None
        self.conx = PDO().create()

    def carregaRanks(self):
        self.ranks = self.conx.query("SELECT * FROM ranks_nomes")
        return self.ranks

    def subirRank(self, qnt: int = None):
        resul = self.conx.query('''SELECT * FROM rank AS rk
                                JOIN users AS u ON u.id = rk.user_id
                                WHERE u.id_discord  = ?''', self.user_id)

        self.user_id = self.cadastrar_user()

        if not resul:
            self.conx.insertUpdate('INSERT INTO rank (rank_id, ponts, user_id) VALUES (?, ?, ?)',
                                   self.ranks[0]['id'], 0, self.user_id)
            self.rank_id_registro = self.conx.query('SELECT id FROM rank WHERE user_id = ?', self.user_id)
        else:
            self.user_id = resul[0]['user_id']
            self.rank_id_registro = self.conx.query('SELECT id FROM rank WHERE user_id = ?', self.user_id)

        if qnt is None:
            resp = self.conx.query('SELECT rank_id FROM rank WHERE id = ?', self.rank_id_registro)
            valor = int(resp[0]['rank_id']) + 1
            self.conx.insertUpdate('UPDATE rank SET rank_id = ?', valor)
            self.conx.insertUpdate('INSERT INTO registro_ranks(de, qual, user_id, user_rank) VALUES (?, ?, ?, ?)',
                                   int(resp[0]['rank_id']), valor, self.user_id, self.rank_id_registro)
            return True
        else:
            resp = self.conx.query('SELECT rank_id FROM rank WHERE id = ?', self.rank_id_registro)
            valor = int(resp[0]['rank_id']) + qnt
            self.conx.insertUpdate('UPDATE rank SET rank_id = ?', valor)
            self.conx.insertUpdate('INSERT INTO registro_ranks(de, qual, user_id, user_rank) VALUES (?, ?, ?, ?)',
                                   int(resp[0]['rank_id']), valor, self.user_id, self.rank_id_registro)
            return True

    def cadastrar_user(self):
        resul = self.conx.query("SELECT * FROM users WHERE id_discord = ? ", [self.user_id])

        if resul == None:

            self.conx.insertUpdate("INSERT INTO users (id_discord) VALUES (?)", [self.user_id])
            resp = self.conx.query("SELECT id FROM users WHERE id_discord = ?", [self.user_id])
            return resp[0]['id']
        else:
            return resul[0]['id']


sql = Rank('10000092129232')
resul = sql.subirRank()
